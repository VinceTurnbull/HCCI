with claims_table as(
select *
FROM "testdb"."vt_sample_claimants_adddsc"
  ),


/*****************Outpatient ********************/
add_OP_key as (
select *
, (case when major_service_category = 'Outpatient Facility' then  concat(cast(service_from_date as varchar), member_ssn, provider_tin, dsc_with_hierarchy) 
   else NULL end) as OP_unique_key
from claims_table 
),



OP_Enc_Assignment as (
select OP_unique_key
, sum(allowed_amount) as allowed 
, (case when (OP_unique_key in ('',' ') or OP_unique_key is NULL) then NULL
when sum(allowed_amount) > 0 then 1 
when sum(allowed_amount) < 0 then -1 
else 0 end) as OP_enc_assignment
from add_OP_key 
group by 1),


Rank_OP_Rows as (
select * 
, (row_number() over (partition by OP_unique_key ORDER BY service_from_date asc) ) AS OP_ENC_ROW_RANK
from add_OP_key
where major_service_category = 'Outpatient Facility'),


add_Enc_Service_Counts as (
select a.*
, (case when a.allowed_amount > 0 then 1
   when a.allowed_amount < 0 -1 then -1
   else 0 end ) as Service_Count
, (case when b.OP_enc_assignment = 1 then 1 else 0 end ) as Reversal_Flag
from (

select a.*
, b.OP_enc_assignment as Encounter_Count
from Rank_OP_Rows a
left join OP_Enc_Assignment b
on a.OP_unique_key = b.OP_unique_key
and a.OP_ENC_ROW_RANK = 1
-- and cast(a.op_fac_hiearchy_final as integer) <= 3
  ) a
left join OP_Enc_Assignment b
on a.OP_unique_key = b.OP_unique_key )





