

-- sample claims table to 100,000 claimants

with claims_sample as(
select * 
from analytics_dw.medical_claims
where member_ssn in (
select distinct member_ssn
from analytics_dw.medical_claims
where year(service_from_date) = 2019
limit 100000)),

-- initial map of IP Fac based on Code
map_IP_Fac as(
  
  select a.*
  , (case when a.pos in ('31','32','33') then 'SNF'
     when a.pos in ('34') then 'Hospice'
     else b.hcci_detailed_service_class end) as IP_DSC
  , b.mdc as IP_MDC
  from claims_sample a
  left join "testdb"."servicemapping_drgs" b
  on a.drg = b.drg
),

-- clean up IP fac not labeled usually for DRG 999, ungroupable drgs

Final_map_IP_Fac as(
  
  select a.*
 , (case when (a.service_type = 'Inpatient Facility' and (IP_DSC in('', ' ') or IP_DSC is null)) then 'Other'
  else IP_DSC end) as final_IP_DSC
  from map_IP_Fac a
)


select service_type
, final_IP_DSC
, sum(allowed_amount)
, count(*)
from Final_map_IP_Fac
group by 1,2
order by 1,2


