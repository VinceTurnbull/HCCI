
/*
-- sample claims table to 100,000 claimants

with claims_sample as(
select * 
from analytics_dw.medical_claims
where member_ssn in (
select distinct member_ssn
from analytics_dw.medical_claims
where year(service_from_date) = 2019
limit 100000)),

-- Fix errors with service type field
-- professional logic also assigns all J codes to professional and for some reason it looks like DRGs are getting mapped to prof
fix_service_type as (
  select a.*
   , (case when (a.procedure_code between 'J0000' and 'J9999') then 'Professional Services'
       when (a.drg not in ('', ' ') and drg is not NULL) then 'Inpatient Facility' 
      else a.service_type end ) as major_service_category
  from claims_sample a),*/
  
with sample_data as (  
SELECT *
FROM "testdb"."vt_sample_claimants") ,

/********************************** Inpatient *****************************/

-- initial map of IP Fac based on Code
map_IP_Fac as(
  
  select a.*
  , (case when a.pos in ('31','32','33') then 'SNF'
     when a.pos in ('34') then 'Hospice'
     else b.hcci_detailed_service_class end) as IP_DSC
  , b.mdc_grouping as DRG_MDC_grouping
  , b.description as DRG_MDC_description
  from sample_data a
  left join "testdb"."servicemapping_drgs" b
  on a.drg = b.drg
),

-- clean up IP fac not labeled usually for DRG 999, ungroupable drgs

Final_map_IP_Fac as(
  
  select a.*
 , (case when (a.major_service_category = 'Inpatient Facility' and (IP_DSC in('', ' ') or IP_DSC is null)) then 'Other'
  else IP_DSC end) as final_IP_DSC
  from map_IP_Fac a
),

/********************************** Professional *****************************/
-- add professional

Add_prof_service_cat as(
    select a.*
     ,  (case when a.major_service_category = 'Professional Services' 
             then b.subcategory else NULL end) as Prof_DSC
  from Final_map_IP_Fac a
  left join"testdb"."servicemapping_profprocs"  b
  on a.procedure_code = b.code),
  
-- clean up Prof not labeled (all codes not on the mapping)
Final_map_prof_service_cat as (

  select a.*
  , (case when (a.major_service_category = 'Professional Services' and (Prof_DSC in('', ' ') or Prof_DSC is null)) then 'Other'
     else Prof_DSC end) as final_Prof_DSC
     from Add_prof_service_cat a
     ),

/********************************** Outpatient *****************************/
-- Add OP facility 
 
Add_OP_Fac_Rev as (
    select a.*
  , (case when a.major_service_category = 'Outpatient Facility' then
     b.hcci_detailed_servicecategory else NULL end) as OP_DSC_rev
  
  , (case when a.major_service_category = 'Outpatient Facility' then
     b.subcategory else NULL end) as OP_Fac_subcategory_rev

  , (case when a.major_service_category = 'Outpatient Facility' then
     b.rank else NULL end) as OP_Fac_Rank_rev

  from Final_map_prof_service_cat a
  left join "testdb"."servicemapping_revcodes" b
  on a.revenue_code = b.rev_code),

-- HCCI OP fac mapping on proc codes
Add_OP_Fac_Proc as (
    select a.*
  , (case when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev not in('', ' ') or OP_DSC_rev is null)) then OP_DSC_rev
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '12') then 'Home Health' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '23') then 'Emergency Room' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.procedure_code in 
           (select code from "testdb"."servicemapping_opfac_proccodes" )) then b.detailed_service_category
     else 'Outpatient Other' end) as OP_DSC_proc
     
     
     
  , (case when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev not in('', ' ') or OP_DSC_rev is null)) then OP_Fac_subcategory_rev
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '12') then 'Other' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '23') then 'Visits' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.procedure_code in 
           (select code from "testdb"."servicemapping_opfac_proccodes" )) then b.subcategory
     else 'Other' end) as OP_Fac_subcategory_proc

     
  -- note, mapping "other" to last rank
  
  , (case when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev not in('', ' ') or OP_DSC_rev is null)) then OP_Fac_Rank_rev
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '12') then '9' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.pos = '23') then '1' 
     when (a.major_service_category = 'Outpatient Facility' and (OP_DSC_rev in('', ' ') or OP_DSC_rev is null) and a.procedure_code in 
           (select code from "testdb"."servicemapping_opfac_proccodes" )) then b.hierarchy
     else '10' end) as OP_Fac_hiearchy
  
  -- add unique key to join hierarchy back to
  , concat(member_ssn, cast(service_from_date as varchar)) as unique_key
    
  from Add_OP_Fac_Rev a
  left join "testdb"."servicemapping_opfac_proccodes" b
  on a.procedure_code = b.code),


-- OP Hierarchy
OP_Hierarchy as (
select * 
  , (case when Top_OP_Rank = 1 then 'Emergency Room'
  when Top_OP_Rank = 2 then 'Outpatient Surgery'
  when Top_OP_Rank = 3 then 'Observation'
  else NULL end) as Top_OP_DSC
  from (
select unique_key
, min(OP_Fac_hiearchy) over(Partition by unique_key) as Top_OP_Rank
from (
select member_ssn
,(case when major_service_category = 'Outpatient Facility' then OP_DSC_proc
 when major_service_category = 'Inpatient Facility' then final_IP_DSC
 else final_Prof_DSC end) as DSC_No_Hierarchy
, unique_key
, cast(OP_Fac_hiearchy as integer) as OP_Fac_hiearchy
from Add_OP_Fac_Proc 
where major_service_category = 'Outpatient Facility'
and OP_Fac_subcategory_proc = 'Visits'))
group by 1,2
),

-- edit the OP fac rank and DSC
add_edit_OP_fac_rank as(
select a.*
, (case when a.OP_Fac_hiearchy_edit is NULL then a.OP_Fac_hiearchy 
   else a.OP_Fac_hiearchy_edit end ) as OP_Fac_hiearchy_final

, (case when a.OP_Fac_DSC_edit is NULL then a.OP_DSC_proc
   else a.OP_Fac_DSC_edit end ) as OP_Fac_DSC_final

  
from (

select a.*
, (case when a.major_service_category = 'Outpatient Facility' then cast(b.Top_OP_Rank as varchar)
   else NULL end) as OP_Fac_hiearchy_edit

, (case when a.major_service_category = 'Outpatient Facility' then b.Top_OP_DSC 
   else NULL end) as OP_Fac_DSC_edit

    
from Add_OP_Fac_Proc a
left join OP_Hierarchy b 
on a.unique_key = b.unique_key) a),


  
-- Final DSC
map_Final_DSC as(
select a.* 

, (case when a.major_service_category = 'Outpatient Facility' then a.OP_DSC_proc
when a.major_service_category = 'Inpatient Facility' then a.final_IP_DSC
else a.final_Prof_DSC end) as DSC_No_Hierarchy
  
  
, (case when a.major_service_category = 'Outpatient Facility' then a.OP_Fac_DSC_final
when a.major_service_category = 'Inpatient Facility' then a.final_IP_DSC
else a.final_Prof_DSC end) as DSC_With_Hierarchy
  
from add_edit_OP_fac_rank a)



select major_service_category	
, DSC_With_Hierarchy   
, sum(allowed_amount)
from map_Final_DSC
group by 1,2
order by 1,2










